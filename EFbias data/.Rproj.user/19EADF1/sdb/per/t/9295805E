{
    "collab_server" : "",
    "contents" : "require(dplyr)\n\n# Creates a file to use to plot grand averages\n\nTBTpath = \"./2 files from SCAN/\"\nelectrodeList = c(\"F3\", \"FZ\", \"F4\", \"FC3\", \"FCZ\", \"FC4\", \"C3\", \"CZ\", \"C4\") # specify electrodes that you want quantified\nsubList = c(\"1018\", \"1035\", \"1037\", \"1039\", \"1043\", \"1044\", \"1048\", \"1501\", \"1502\", \"1504\", \"1505\", \"1507\",\n           \"1509\", \"1510\", \"1511\", \"1515\", \"1516\", \"1517\", \"1518\", \"1521\", \"1522\", \"1525\", \"1526\", \"1527\", \"1529\",\n           \"1530\", \"1532\", \"1535\", \"1536\", \"1537\", \"1538\", \"1539\", \"1540\", \"1541\", \"1542\", \"1543\", \"1544\", \"1545\",\n           \"1546\", \"1547\", \"1548\", \"1551\", \"1552\", \"1553\", \"1555\", \"1556\", \"1557\", \"1558\", \"1559\", \"1561\", \"1565\",\n           \"1566\", \"1568\", \"1570\", \"1571\", \"1572\", \"1575\", \"1576\", \"1577\", \"1578\",\n           \"2001\", \"2003\", \"2004\", \"2006\", \"2007\", \"2008\", \"2013\", \"2016\", \"2020\", \"2021\", \"2024\", \"2026\",\n           \"2028\", \"2030\", \"2031\", \"2034\", \"2038\", \"2039\", \"2048\", \"2050\", \"2051\", \"2059\", \"2061\", \"2062\", \"2064\",\n           \"2065\", \"2066\", \"2070\", \"2083\", \"2092\", \"2094\", \"2095\", \"2099\", \"2100\", \"2101\", \"2102\",\n           \"2103\", \"2104\", \"2109\", \"2115\", \"2116\", \"2125\", \"2130\", \"2132\", \"2133\", \"2134\", \"2137\", \"2144\", \"2146\",\n           \"2148\", \"2149\", \"2158\", \"2159\", \"2160\", \"2161\", \"2162\", \"2163\", \"2164\", \"2165\", \"2166\",\n           \"2167\", \"2168\", \"2169\", \"2170\", \"2171\", \"2172\", \"2174\", \"2175\", \"2176\", \"2177\", \"2178\", \"2179\",\n            \"2183\", \"2186\")\n\nbeginEpoch = -400 # how many ms before onset does epoch start\nendEpoch = 500 # how many ms after onset does epoch end\nlengthEpoch = endEpoch - beginEpoch + 1\n\nallSubs = NULL\nfor (k in subList) {\n  \n  # read in trial-by-trial point data\n  temp = read.delim(paste(TBTpath, k, \"_TBT.dat\", sep=\"\"), skip=2, header=FALSE, colClasses = \"numeric\") \n  names(temp) = electrodeList # replace column names\n  temp = temp[,1:length(electrodeList)] # get rid of last NA column\n  \n  numTrials = nrow(temp)/lengthEpoch # figures out how many trials are in data\n  \n  # add identifiers\n  temp$Subject = k\n  temp$Points = rep(1:lengthEpoch, numTrials)\n  temp$Time = rep(beginEpoch:endEpoch, numTrials)\n  temp$Trial = rep(1:numTrials, each = lengthEpoch)\n  \n  # read in file of rejected trials\n  rej = read.delim(paste(TBTpath, k, \"_REJ.dat\", sep=\"\"), header=FALSE, colClasses = \"numeric\") \n  rej$Trial = row.names(rej)\n  # read in event file to add whether response was correct, condition, etc.\n  ev2 = read.delim(paste(\"./1 event files/revised/\", k, \".txt\", sep=\"\"), header=FALSE)\n  ev2$V1 = 1:384\n  \n  # figure out which trials to use\n  nomissTrials = ev2$V1[ev2$V4 != -1] # no miss trials\n  accTrials = rej$Trial[rej$V1 == 1] # trials with no artifacts\n  respTrials = ev2$V1[ev2$V5 <= .5 & ev2$V5 >= .2]\n  \n  useTrials = nomissTrials[nomissTrials %in% accTrials & nomissTrials %in% respTrials]\n  \n  # make data frame just with trials we're going to include in model (no artifacts, RT between 200 and 500 ms, no miss)\n  temp.select = filter(temp, Trial %in% useTrials)\n\n  # Take out data if electrode is bad\n  badElec = read.delim(paste(TBTpath, k, \"_chan.log\", sep=\"\"), header = T)\n  badElec$Channel = electrodeList\n  # Take data just for good electrodes\n  good = as.numeric(row.names(badElec[badElec$Bad == 0,]))\n  goodElec = temp.select[,good]\n  # Average them together\n  goodElec$avgElec = rowSums(goodElec)/ncol(goodElec)\n  \n  # paste that back onto original data set\n  temp.select = cbind(temp.select, goodElec$avgElec) %>% \n    rename(avgElec = `goodElec$avgElec`)\n\n  # add accuracy information\n  names(ev2) = c(\"Trial\", \"Trigger\", \"Resp\", \"Acc\", \"RT\", \"Onset\")\n  ev2$Trial = 1:384\n  \n  errTrials = ev2$Trial[ev2$Acc == 0] \n  accTrials = ev2$Trial[ev2$Acc == 1]\n  \n  temp.select$Accuracy = NA\n  temp.select$Accuracy[temp.select$Trial %in% errTrials] = \"incorrect\"\n  temp.select$Accuracy[temp.select$Trial %in% accTrials] = \"correct\"\n  \n  # add trial information\n  BTtrials = ev2$Trial[ev2$Trigger == 8]\n  temp.select$Condition[temp.select$Trial %in% BTtrials] = \"Black_tool\"\n  \n  BGtrials = ev2$Trial[ev2$Trigger == 7]\n  temp.select$Condition[temp.select$Trial %in% BGtrials] = \"Black_gun\"\n  \n  WTtrials = ev2$Trial[ev2$Trigger == 11]\n  temp.select$Condition[temp.select$Trial %in% WTtrials] = \"White_tool\"\n  \n  WGtrials = ev2$Trial[ev2$Trigger == 10]\n  temp.select$Condition[temp.select$Trial %in% WGtrials] = \"White_gun\"\n  \n  # average across trials of each type\n  indivAvg = temp.select %>% \n    select(-Points, -Trial, -Subject) %>% \n    group_by(Condition, Accuracy, Time) %>% \n    summarise_each(funs(mean)) %>% \n    as.data.frame()\n  \n  indivAvg$Subject = k\n  \n  allSubs = rbind(allSubs, indivAvg)\n}\n\n# Add variable for plotting  \nallSubs$plotCondition = paste(allSubs$Condition, allSubs$Accuracy, sep=\"_\")\n\nwrite.table(allSubs, \"./5 waveforms/data/Data for indiv averages_allelec.txt\", row.names = F, sep=\"\\t\")\n\n\n\n# Average across subjects for grand averages ------------------------------\n\n\nallSubs = read.delim(\"./5 waveforms/data/Data for indiv averages_allelec.txt\")\n\ngrand = select(allSubs, -Subject, -Condition, -Accuracy) %>% \n  group_by(plotCondition, Time) %>% \n  summarise_each(funs(mean)) %>% \n  as.data.frame()\n\nwrite.table(grand, \"./5 waveforms/data/Data for grand averages_allelec.txt\", row.names = F, sep=\"\\t\")\n\n# plot grand averages\nrequire(ggplot2)\nrequire(colorspace)\nrequire(grid)\n\ncondLine <- c(\"Black_gun_correct\" = \"dashed\",    # CRN is dashed\n              \"Black_tool_correct\" = \"dashed\", \n              \"White_gun_correct\" = \"dashed\", \n              \"White_tool_correct\" = \"dashed\",\n              \"Black_gun_incorrect\" = \"solid\",  # ERN is solid\n              \"Black_tool_incorrect\" = \"solid\", \n              \"White_gun_incorrect\" = \"solid\", \n              \"White_tool_incorrect\" = \"solid\")\n\n\ncondColors <- c(\"Black_gun_correct\" = \"red\", \n                \"Black_tool_correct\" = \"darkred\", \n                \"White_gun_correct\" = \"gray44\", \n                \"White_tool_correct\" = \"black\",\n                \"Black_gun_incorrect\" = \"red\", \n                \"Black_tool_incorrect\" = \"darkred\", \n                \"White_gun_incorrect\" = \"gray44\", \n                \"White_tool_incorrect\" = \"black\")\n\nERPline = geom_line(lwd=1.1,\n                    #linetype=plotCondition,\n                    aes(color = plotCondition, linetype = plotCondition))\n\n\nERNbox = annotate(\"rect\",\n                 xmin=25, xmax=125, ymin=-Inf, ymax=Inf, \n                 alpha=0,\n                 fill=\"#F0E0FF\",\n                 color=\"black\", \n                 linetype=\"dashed\") \n\nnone = element_blank() \n\n# average of all 9 electrodes\nggplot(data=grand, aes(Time, avgElec, group = plotCondition)) + \n  ERPline + \n  ERNbox + \n  theme_bw() + \n  theme(panel.grid.major.x = none, panel.grid.minor.x = none) +\n  scale_x_continuous(\"Time (ms)\", \n                     limits=c(-400, 500), \n                     expand=c(0,0),   # expand=c(0,0) removes extra space before & after data\n                     breaks=c(-400, -300, -200, -100, 0, 100, 200, 300, 400, 500)) +\n  geom_hline(yintercept=0) + # adds x axis\n  geom_vline(xintercept=0) +\n  scale_y_reverse(limits =c(10, -7.5)) +  # scale_y_reverse flips y axis\n  ylab(\"Amplitude (uV)\") +\n  scale_color_manual(values=condColors) +\n  scale_linetype_manual(values=condLine) +\n  ggtitle(\"Average of fronto-central electrodes\") +\n  theme(plot.title = element_text(hjust = 0.5)) # center title\n\n\n",
    "created" : 1488999321671.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "954587044",
    "id" : "9295805E",
    "lastKnownWriteTime" : 1489017784,
    "last_content_update" : 1489017784835,
    "path" : "~/Documents/Projects/6 MLM Psychophys paper/EFbias data/7 Plot grand average waveforms.R",
    "project_path" : "7 Plot grand average waveforms.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}